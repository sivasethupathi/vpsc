<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Test Platform</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .option-label {
            transition: all 0.2s ease-in-out;
        }
        .option-label:hover {
            background-color: #eef2ff; /* indigo-50 */
        }
        input[type="radio"]:checked + .option-label {
            background-color: #c7d2fe; /* indigo-200 */
            border-color: #6366f1; /* indigo-500 */
        }
    </style>
</head>
<body class="bg-slate-100 flex items-center justify-center min-h-screen">

    <div id="main-container" class="bg-white p-6 sm:p-8 rounded-2xl shadow-lg w-full max-w-3xl transition-all duration-500">
        
        <!-- Start Screen -->
        <div id="start-screen" class="text-center">
            <h1 class="text-3xl sm:text-4xl font-bold text-slate-800 mb-4">PNB VIGILANCE TEAM, CHENNAI </h1>
            <p class="text-slate-600 mb-8 max-w-md mx-auto">You will be presented with 10 random questions. You'll have 10 minutes to complete the test. Click the button below to begin.</p>
            <button id="start-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                Start Test
            </button>
        </div>

        <!-- Test Screen -->
        <div id="test-screen" class="hidden">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800">Question <span id="question-number"></span>/10</h2>
                <div id="timer" class="text-xl font-bold bg-indigo-100 text-indigo-700 px-4 py-2 rounded-lg">10:00</div>
            </div>
            <div id="question-container">
                <p id="question-text" class="text-lg text-slate-700 mb-6 min-h-[60px]"></p>
                <div id="options-container" class="space-y-3">
                    <!-- Options will be dynamically inserted here -->
                </div>
            </div>
            <div class="flex justify-between mt-8">
                <button id="prev-btn" class="bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-400 focus:outline-none focus:ring-4 focus:ring-slate-200">Previous</button>
                <button id="next-btn" class="bg-indigo-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300">Next</button>
                <button id="submit-btn" class="hidden bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300">Submit Test</button>
            </div>
        </div>

        <!-- Results Screen -->
        <div id="results-screen" class="hidden">
            <h2 class="text-3xl sm:text-4xl font-bold text-slate-800 text-center mb-2">Test Complete!</h2>
            <p class="text-center text-slate-600 mb-6">Here's how you did:</p>
            <div class="bg-indigo-50 border-2 border-indigo-200 rounded-xl p-6 text-center mb-8">
                <p class="text-lg text-slate-700">Your Score</p>
                <p class="text-6xl font-extrabold text-indigo-600"><span id="score"></span><span class="text-3xl font-medium text-slate-500">/10</span></p>
            </div>

            <h3 class="text-2xl font-bold text-slate-800 mb-4">Answer Summary</h3>
            <div id="summary-container" class="space-y-4 max-h-[40vh] overflow-y-auto pr-2">
                <!-- Summary will be dynamically inserted here -->
            </div>
            <div class="text-center mt-8">
                 <button id="restart-btn" class="bg-indigo-600 text-white font-bold py-3 px-8 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-4 focus:ring-indigo-300 transition-transform transform hover:scale-105">
                    Take Another Test
                </button>
            </div>
        </div>
        
        <!-- Loading Spinner -->
        <div id="loading-spinner" class="hidden text-center">
            <svg class="animate-spin h-10 w-10 text-indigo-600 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <p class="mt-4 text-slate-600">Loading...</p>
        </div>

    </div>

    <!-- Confirmation Modal -->
    <div id="confirmation-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl text-center w-full max-w-sm">
            <h3 class="text-xl font-bold text-slate-800 mb-4">Are you sure?</h3>
            <p class="text-slate-600 mb-8">Do you want to submit your test?</p>
            <div class="flex justify-center gap-4">
                <button id="cancel-submit-btn" class="bg-slate-300 text-slate-800 font-bold py-2 px-6 rounded-lg hover:bg-slate-400 focus:outline-none focus:ring-4 focus:ring-slate-200">Cancel</button>
                <button id="confirm-submit-btn" class="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700 focus:outline-none focus:ring-4 focus:ring-green-300">Submit</button>
            </div>
        </div>
    </div>


    <script>
        const startScreen = document.getElementById('start-screen');
        const testScreen = document.getElementById('test-screen');
        const resultsScreen = document.getElementById('results-screen');
        const mainContainer = document.getElementById('main-container');
        const loadingSpinner = document.getElementById('loading-spinner');

        const startBtn = document.getElementById('start-btn');
        const nextBtn = document.getElementById('next-btn');
        const prevBtn = document.getElementById('prev-btn');
        const submitBtn = document.getElementById('submit-btn');
        const restartBtn = document.getElementById('restart-btn');

        const questionNumberEl = document.getElementById('question-number');
        const questionTextEl = document.getElementById('question-text');
        const optionsContainer = document.getElementById('options-container');
        const timerEl = document.getElementById('timer');
        
        const scoreEl = document.getElementById('score');
        const summaryContainer = document.getElementById('summary-container');

        const confirmationModal = document.getElementById('confirmation-modal');
        const cancelSubmitBtn = document.getElementById('cancel-submit-btn');
        const confirmSubmitBtn = document.getElementById('confirm-submit-btn');

        // IMPORTANT: For local development, use your Python backend URL (e.g., http://127.0.0.1:5000).
        // This is a common source of "network response not ok" errors if the backend isn't running
        // or is on a different address.
        // When deploying to a service like PythonAnywhere, this can be changed
        // back to window.location.origin if frontend and backend are on the same domain.
        const API_BASE_URL = 'http://127.0.0.1:5000';

        let questions = [];
        let currentQuestionIndex = 0;
        let userAnswers = [];
        let timerInterval;

        startBtn.addEventListener('click', startTest);
        nextBtn.addEventListener('click', nextQuestion);
        prevBtn.addEventListener('click', prevQuestion);
        submitBtn.addEventListener('click', confirmAndSubmit);
        restartBtn.addEventListener('click', () => location.reload());
        cancelSubmitBtn.addEventListener('click', () => confirmationModal.classList.add('hidden'));
        confirmSubmitBtn.addEventListener('click', () => {
            confirmationModal.classList.add('hidden');
            submitTest();
        });


        function showScreen(screen) {
            startScreen.classList.add('hidden');
            testScreen.classList.add('hidden');
            resultsScreen.classList.add('hidden');
            loadingSpinner.classList.add('hidden');
            screen.classList.remove('hidden');
        }

        async function startTest() {
            showScreen(loadingSpinner);
            try {
                const response = await fetch(`${API_BASE_URL}/get_questions`);
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                questions = await response.json();
                userAnswers = new Array(questions.length).fill(null);
                currentQuestionIndex = 0;
                showScreen(testScreen);
                displayQuestion();
                startTimer();
            } catch (error) {
                console.error('Failed to fetch questions:', error);
                startScreen.innerHTML = `<p class="text-red-500 font-semibold">Error: Could not load questions.</p> <p class="text-slate-600 mt-2">Please ensure the Python backend server is running and the API_BASE_URL is correct.</p>`;
                showScreen(startScreen);
            }
        }

        function displayQuestion() {
            const question = questions[currentQuestionIndex];
            questionNumberEl.textContent = currentQuestionIndex + 1;
            questionTextEl.textContent = question.Question;
            optionsContainer.innerHTML = '';

            const options = ['A', 'B', 'C', 'D', 'E'];
            options.forEach(optionKey => {
                const optionValue = question[`Option${optionKey}`];
                if (optionValue) {
                    const optionElement = document.createElement('div');
                    const radioId = `q${currentQuestionIndex}_option${optionKey}`;
                    
                    optionElement.innerHTML = `
                        <input type="radio" id="${radioId}" name="question${currentQuestionIndex}" value="${optionKey}" class="hidden">
                        <label for="${radioId}" class="option-label flex items-center p-4 border-2 rounded-lg cursor-pointer">
                            <span class="font-bold mr-4">${optionKey}</span>
                            <span>${optionValue}</span>
                        </label>
                    `;
                    optionsContainer.appendChild(optionElement);
                    
                    const radio = optionElement.querySelector('input[type="radio"]');
                    if (userAnswers[currentQuestionIndex] === optionKey) {
                        radio.checked = true;
                    }
                    radio.addEventListener('change', () => {
                        userAnswers[currentQuestionIndex] = radio.value;
                    });
                }
            });

            updateNavigationButtons();
        }

        function updateNavigationButtons() {
            prevBtn.classList.toggle('hidden', currentQuestionIndex === 0);
            nextBtn.classList.toggle('hidden', currentQuestionIndex === questions.length - 1);
            submitBtn.classList.toggle('hidden', currentQuestionIndex !== questions.length - 1);
        }

        function saveAnswer() {
             const selectedOption = document.querySelector(`input[name="question${currentQuestionIndex}"]:checked`);
            if (selectedOption) {
                userAnswers[currentQuestionIndex] = selectedOption.value;
            }
        }

        function nextQuestion() {
            saveAnswer();
            if (currentQuestionIndex < questions.length - 1) {
                currentQuestionIndex++;
                displayQuestion();
            }
        }
        
        function prevQuestion() {
            saveAnswer();
            if (currentQuestionIndex > 0) {
                currentQuestionIndex--;
                displayQuestion();
            }
        }

        function confirmAndSubmit() {
            saveAnswer();
            confirmationModal.classList.remove('hidden');
        }

        async function submitTest() {
            clearInterval(timerInterval);
            showScreen(loadingSpinner);
            
            const submissionData = questions.map((q, index) => ({
                Question: q.Question,
                selected_answer: userAnswers[index]
            }));

            try {
                const response = await fetch(`${API_BASE_URL}/submit_test`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(submissionData),
                });
                if (!response.ok) {
                    throw new Error('Submission failed');
                }
                const results = await response.json();
                displayResults(results);
            } catch (error) {
                console.error('Failed to submit test:', error);
                resultsScreen.innerHTML = `<p class="text-red-500">Error: Could not submit test. Please try again later.</p>`;
                showScreen(resultsScreen);
            }
        }
        
        function displayResults(results) {
            showScreen(resultsScreen);
            scoreEl.textContent = results.score;
            summaryContainer.innerHTML = '';

            results.summary.forEach((item, index) => {
                const isCorrect = item.status === 'Correct';
                const summaryCard = document.createElement('div');
                summaryCard.className = `p-4 rounded-lg border-2 ${isCorrect ? 'bg-green-50 border-green-200' : 'bg-red-50 border-red-200'}`;
                
                let userAnswerText = 'Not Answered';
                if (item.selected_answer && questions[index]['Option' + item.selected_answer]) {
                    userAnswerText = `${item.selected_answer}. ${questions[index]['Option' + item.selected_answer]}`;
                }

                summaryCard.innerHTML = `
                    <p class="font-bold text-slate-800 mb-2">${index + 1}. ${item.question}</p>
                    <p class="text-sm ${isCorrect ? 'text-green-700' : 'text-red-700'}">Your Answer: ${userAnswerText}</p>
                    <p class="text-sm text-slate-600">Correct Answer: ${item.correct_answer_key}. ${item.correct_answer_value}</p>
                `;
                summaryContainer.appendChild(summaryCard);
            });
        }

        function startTimer() {
            let time = 10 * 60; // 10 minutes in seconds
            timerInterval = setInterval(() => {
                const minutes = Math.floor(time / 60);
                let seconds = time % 60;
                seconds = seconds < 10 ? '0' + seconds : seconds;

                timerEl.textContent = `${minutes}:${seconds}`;
                
                if (--time < 0) {
                    clearInterval(timerInterval);
                    timerEl.textContent = "Time's Up!";
                    timerEl.classList.add('bg-red-200', 'text-red-800');
                    submitTest();
                }
            }, 1000);
        }
    </script>
</body>
</html>

