<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Mock Test (10 Questions)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; }
    body { margin: 0; background: #f7f7fb; }
    .wrap { max-width: 900px; margin: 32px auto; padding: 0 16px; }
    .card { background: #fff; border-radius: 14px; box-shadow: 0 6px 20px rgba(0,0,0,.06); padding: 20px; margin-bottom: 16px; }
    .row { display: flex; align-items: center; justify-content: space-between; gap: 12px; }
    .btn { padding: 10px 16px; border-radius: 10px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .btn.primary { background: #1a73e8; color: #fff; border-color: #1a73e8; }
    .btn:disabled { opacity: .6; cursor: not-allowed; }
    .options { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-top: 10px; }
    .opt { padding: 10px; border: 1px solid #ddd; border-radius: 10px; cursor: pointer; background: #fafafa; }
    .opt.selected { outline: 2px solid #1a73e8; background: #eef4ff; }
    .timer { font-weight: 700; font-variant-numeric: tabular-nums; }
    .hidden { display: none; }
    .qnum { color: #666; font-size: 14px; margin-bottom: 4px; }
    .question { font-size: 18px; font-weight: 600; }
    .summary-table { width: 100%; border-collapse: collapse; margin-top: 8px; }
    .summary-table th, .summary-table td { border: 1px solid #e5e7eb; padding: 8px; font-size: 14px; }
    .ok { color: #0a8a2a; font-weight: 700; }
    .bad { color: #c22; font-weight: 700; }
    .footer { text-align: center; color: #666; font-size: 13px; margin-top: 12px; }
  </style>
</head>
<body>
  <div class="wrap">
    <div class="card">
      <div class="row">
        <h2 style="margin:0">Mock Test</h2>
        <div>Time left: <span class="timer" id="timer">--:--</span></div>
      </div>
      <div class="row" style="margin-top:10px;">
        <div>
          <label for="qCount">Questions:</label>
          <input id="qCount" type="number" min="1" max="50" value="10" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:8px;">
          <label for="minutes" style="margin-left:10px;">Minutes:</label>
          <input id="minutes" type="number" min="1" max="180" value="10" style="width:60px; padding:6px; border:1px solid #ddd; border-radius:8px;">
        </div>
        <div>
          <button id="startBtn" class="btn primary">Start Test</button>
          <button id="submitBtn" class="btn" disabled>Submit</button>
        </div>
      </div>
    </div>

    <div id="questionArea"></div>

    <div id="resultCard" class="card hidden"></div>

    <div class="footer">Built for your group â€“ runs on a free Vercel + Python backend.</div>
  </div>

  <script>
    const API_BASE = ""; // same origin; if needed, set to your deployed URL
    const state = {
      quizId: null,
      questions: [],
      answers: {}, // qid -> "A".."E"
      timer: null,
      timeLeft: 0
    };

    const el = (id) => document.getElementById(id);
    const questionArea = el("questionArea");
    const timerSpan = el("timer");
    const startBtn = el("startBtn");
    const submitBtn = el("submitBtn");
    const resultCard = el("resultCard");

    function fmtSecs(s) {
      const m = Math.floor(s / 60);
      const ss = s % 60;
      return `${String(m).padStart(2,"0")}:${String(ss).padStart(2,"0")}`;
    }

    function startTimer(totalMinutes) {
      if (state.timer) clearInterval(state.timer);
      state.timeLeft = Math.max(1, totalMinutes) * 60;
      timerSpan.textContent = fmtSecs(state.timeLeft);
      state.timer = setInterval(() => {
        state.timeLeft--;
        timerSpan.textContent = fmtSecs(state.timeLeft);
        if (state.timeLeft <= 0) {
          clearInterval(state.timer);
          submitQuiz(); // auto-submit on time up
        }
      }, 1000);
    }

    function renderQuestions(questions) {
      questionArea.innerHTML = "";
      questions.forEach((q, idx) => {
        const card = document.createElement("div");
        card.className = "card";

        const qnum = document.createElement("div");
        qnum.className = "qnum";
        qnum.textContent = `Question ${idx + 1} of ${questions.length}`;
        card.appendChild(qnum);

        const qtext = document.createElement("div");
        qtext.className = "question";
        qtext.textContent = q.question;
        card.appendChild(qtext);

        const optsWrap = document.createElement("div");
        optsWrap.className = "options";

        Object.entries(q.options).forEach(([letter, text]) => {
          const opt = document.createElement("div");
          opt.className = "opt";
          opt.dataset.qid = q.id;
          opt.dataset.choice = letter;
          opt.textContent = `${letter}. ${text}`;
          opt.onclick = () => {
            state.answers[q.id] = letter;
            // toggle selected styling within this card
            [...optsWrap.children].forEach(c => c.classList.remove("selected"));
            opt.classList.add("selected");
          };
          optsWrap.appendChild(opt);
        });

        card.appendChild(optsWrap);
        questionArea.appendChild(card);
      });
    }

    async function startQuiz() {
      resultCard.classList.add("hidden");
      submitBtn.disabled = true;
      startBtn.disabled = true;

      const n = parseInt(el("qCount").value || "10", 10);
      const minutes = parseInt(el("minutes").value || "10", 10);

      try {
        const res = await fetch(`${API_BASE}/api/start?n=${n}`);
        if (!res.ok) throw new Error("Failed to start quiz");
        const data = await res.json();
        state.quizId = data.quiz_id;
        state.questions = data.questions;
        state.answers = {};
        renderQuestions(state.questions);
        submitBtn.disabled = false;
        startTimer(minutes);
      } catch (e) {
        alert("Error starting quiz. Please try again.");
        console.error(e);
        startBtn.disabled = false;
      }
    }

    async function submitQuiz() {
      submitBtn.disabled = true;
      startBtn.disabled = false;
      if (state.timer) clearInterval(state.timer);

      const payload = {
        quiz_id: state.quizId || "stateless",
        answers: state.answers
      };

      try {
        const res = await fetch(`${API_BASE}/api/submit`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });
        const data = await res.json();
        showResults(data);
        window.scrollTo({ top: 0, behavior: "smooth" });
      } catch (e) {
        alert("Error submitting quiz. Please try again.");
        console.error(e);
      }
    }

    function showResults(data) {
      const { score, total, correct, wrong, details } = data;
      const pct = total ? Math.round((score / total) * 100) : 0;

      let html = `
        <h3 style="margin-top:0">Your Result</h3>
        <div class="row" style="margin-bottom:10px;">
          <div><strong>Score:</strong> ${score}/${total} (${pct}%)</div>
          <div><strong>Correct:</strong> <span class="ok">${correct}</span> &nbsp; <strong>Wrong:</strong> <span class="bad">${wrong}</span></div>
        </div>
        <details open>
          <summary><strong>Answer Summary</strong></summary>
          <table class="summary-table">
            <thead>
              <tr><th>#</th><th>Question</th><th>Your Answer</th><th>Correct</th><th>Status</th></tr>
            </thead>
            <tbody>
      `;

      details.forEach((d, i) => {
        const ytxt = `${d.your_answer}. ${d.options[d.your_answer] ?? ""}`;
        const ctxt = `${d.correct_answer}. ${d.options[d.correct_answer] ?? ""}`;
        html += `
          <tr>
            <td>${i + 1}</td>
            <td>${d.question}</td>
            <td>${ytxt}</td>
            <td>${ctxt}</td>
            <td>${d.is_correct ? '<span class="ok">Correct</span>' : '<span class="bad">Wrong</span>'}</td>
          </tr>
        `;
      });

      html += `
            </tbody>
          </table>
        </details>
      `;

      resultCard.innerHTML = html;
      resultCard.classList.remove("hidden");
    }

    startBtn.addEventListener("click", startQuiz);
    submitBtn.addEventListener("click", submitQuiz);
  </script>
</body>
</html>
